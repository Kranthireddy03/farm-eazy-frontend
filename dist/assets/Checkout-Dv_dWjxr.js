import{r,u as ue,i as me,j as e,h as y}from"./index-D_IIqowu.js";function pe(){return new Promise(A=>{if(window.Razorpay)return A(!0);const j=document.createElement("script");j.src="https://checkout.razorpay.com/v1/checkout.js",j.onload=()=>A(!0),j.onerror=()=>A(!1),document.body.appendChild(j)})}function ye(){const A=()=>{console.log("Retry payment clicked"),W()},j=async()=>{try{const t=JSON.parse(localStorage.getItem("farmeazy_cart")||"[]");ee(t),await de(),await $()}catch{o("Failed to load checkout data","error")}},[J,q]=r.useState(null),[T,D]=r.useState(0),[P,X]=r.useState(null),[K,k]=r.useState(!1),S=ue(),{showToast:o}=me(),[f,ee]=r.useState([]),[I,te]=r.useState(0),[w,se]=r.useState(!1),[F,L]=r.useState(0),ae=()=>{se(!w),L(w?0:Math.min(I,Math.floor(N)))},re=t=>{const a=Math.max(0,Math.min(Number(t.target.value),Math.min(I,Math.floor(N))));L(a)},[u,B]=r.useState("CASH_ON_DELIVERY"),[ne,R]=r.useState(!1),[H,v]=r.useState(!1),[Y,G]=r.useState(!1),[_,oe]=r.useState([]),[g,V]=r.useState(null),[d,Z]=r.useState({fullName:"",phoneNumber:"",email:"",addressLine1:"",addressLine2:"",landmark:"",addressType:"",city:"",state:"",postalCode:""}),le=.18,z=1;if(r.useEffect(()=>{j()},[]),r.useEffect(()=>()=>{P&&clearInterval(P)},[P]),K&&J)return e.jsx("div",{className:"min-h-screen flex flex-col items-center justify-center bg-amber-900/30",children:e.jsxs("div",{className:"bg-slate-800 rounded-lg shadow-lg p-8 max-w-md w-full text-center border border-slate-700",children:[e.jsx("h2",{className:"text-2xl font-bold text-amber-400 mb-4",children:"Order On Hold"}),e.jsx("p",{className:"mb-2 text-slate-300",children:"Your order is on hold due to payment failure."}),e.jsxs("p",{className:"mb-4 text-slate-300",children:["You have",e.jsxs("span",{className:"font-bold text-white",children:[Math.floor(T/60),":",(T%60).toString().padStart(2,"0")]}),"minutes to retry payment."]}),e.jsx("button",{onClick:A,className:"bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition mb-2",disabled:ne,children:"Retry Payment"}),e.jsx("button",{onClick:()=>{k(!1),S("/")},className:"bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg transition",children:"Cancel Order"})]})});const de=async()=>{try{const t=await y.get("/coins");te(t.data.totalCoins||0)}catch(t){console.error("Error fetching coins:",t)}},$=async()=>{try{const t=await y.get("/addresses"),a=Array.isArray(t.data)?t.data:[];oe(a),a.length>0&&V(a[0].id)}catch(t){console.error("Error fetching addresses:",t)}},ie=()=>{const t=f.reduce((b,c)=>{const U=c.discountedPrice&&c.discountedPrice>0?c.discountedPrice:c.price;return b+U*c.quantity},0),a=t*le,s=t+a;return{subtotal:t,tax:a,total:s}},{subtotal:E,tax:O,total:N}=ie(),Q=Math.min(I,Math.floor(N)),i=w?Math.min(F,Q):0,p=Math.max(0,N-i*z),x=t=>{const{name:a,value:s}=t.target;Z({...d,[a]:s})},ce=async t=>{t.preventDefault();try{const a=await y.post("/addresses",d);o("Address added successfully","success"),Z({fullName:"",phoneNumber:"",email:"",addressLine1:"",addressLine2:"",city:"",state:"",postalCode:""}),G(!1),$()}catch{o("Failed to add address","error")}},W=async()=>{console.log("[DEBUG] Checkout triggered. Cart:",f,"Coins:",I,"UseCoins:",w,"CoinsToUse:",F,"CoinsApplied:",i,"FinalAmount:",p,"SelectedPayment:",u);try{if(v(!0),!g){o("Please select or add a delivery address","warning"),v(!1);return}if(u==="RAZORPAY"){if(p<1){alert("Minimum payable amount is â‚¹1"),R(!1),v(!1);return}if(R(!0),!await pe()){o("Failed to load Razorpay. Please try again.","error"),R(!1),v(!1);return}const s={amount:Math.round(p*100),email:_.find(m=>m.id===g)?.email||"",phone:_.find(m=>m.id===g)?.phoneNumber||""};console.log("[DEBUG] Creating Razorpay order with:",s,`(Rupees: â‚¹${p}, Paise: ${Math.round(p*100)})`);const b=await y.post("/api/payment/create-order",s);if(b.status!==200){console.error("Backend order creation failed:",b),o("Order creation failed: "+(b.data||b.statusText),"error"),R(!1),v(!1);return}const c=b.data;console.log("[DEBUG] Razorpay order response:",c);const U={key:c.key_id,amount:c.amount,currency:c.currency,name:"FarmEazy",description:"Order Payment",order_id:c.id,handler:async function(m){console.log("[DEBUG] Razorpay handler response:",m);try{const n=await y.post("/payment/verify",{orderId:c.id,paymentId:m.razorpay_payment_id,signature:m.razorpay_signature,email:s.email,phone:s.phone});if(console.log("[DEBUG] Payment verify result:",n.data),n.data.status==="success"){const h={items:f.map(l=>{const M=l.discountedPrice&&l.discountedPrice>0?l.discountedPrice:l.price;return{productId:l.id,quantity:l.quantity,price:M}}),subtotal:E,taxAmount:O,totalAmount:N,coinsUsed:i,finalAmount:p,paymentMethod:"RAZORPAY",addressId:g,paymentId:m.razorpay_payment_id};console.log("[DEBUG] Placing order after payment success:",h);const C=await y.post("/orders",h);localStorage.removeItem("farmeazy_cart"),localStorage.removeItem("farmeazy_checkout_coins"),o("âœ… Payment successful & order placed!","success"),S(`/order-confirmation/${C.data.id}`)}else{const h={items:f.map(l=>{const M=l.discountedPrice&&l.discountedPrice>0?l.discountedPrice:l.price;return{productId:l.id,quantity:l.quantity,price:M}}),subtotal:E,taxAmount:O,totalAmount:N,coinsUsed:i,finalAmount:p,paymentMethod:"RAZORPAY",addressId:g,paymentStatus:"FAILED",orderStatus:"PENDING",paymentId:m.razorpay_payment_id};console.log("[DEBUG] Creating pending order after payment failure:",h);const C=await y.post("/orders",h);q(C.data.id),k(!0),D(600),o("Payment failed. Order is on hold for 10 minutes. You can retry payment.","warning")}}catch(n){console.error("[DEBUG] Payment verification failed:",n),o("Payment verification failed. Contact support.","error")}},prefill:{email:s.email,contact:s.phone},theme:{color:"#22c55e"},modal:{ondismiss:async function(){const m={items:f.map(n=>{const h=n.discountedPrice&&n.discountedPrice>0?n.discountedPrice:n.price;return{productId:n.id,quantity:n.quantity,price:h}}),subtotal:E,taxAmount:O,totalAmount:N,coinsUsed:i,finalAmount:p,paymentMethod:"RAZORPAY",addressId:g,paymentStatus:"FAILED",orderStatus:"PENDING"};try{const n=await y.post("/orders",m);q(n.data.id),k(!0),D(600),o("Payment failed. Order is on hold for 10 minutes. You can retry payment.","warning"),P&&clearInterval(P);const h=setInterval(()=>{D(C=>C<=1?(clearInterval(h),k(!1),y.patch(`/orders/${n.data.id}/cancel`),o("Order cancelled due to payment timeout.","error"),0):C-1)},1e3);X(h)}catch{o("Failed to create pending order.","error")}}}};new window.Razorpay(U).open()}if(u==="CASH_ON_DELIVERY"){const t={items:f.map(s=>{const b=s.discountedPrice&&s.discountedPrice>0?s.discountedPrice:s.price;return{productId:s.id,quantity:s.quantity,price:b}}),subtotal:E,taxAmount:O,totalAmount:N,coinsUsed:i,finalAmount:p,paymentMethod:"CASH_ON_DELIVERY",addressId:g},a=await y.post("/orders",t);localStorage.removeItem("farmeazy_cart"),localStorage.removeItem("farmeazy_checkout_coins"),o("âœ… Order placed successfully!","success"),S(`/order-confirmation/${a.data.id}`)}}catch(t){o("Failed to place order: "+t.message,"error"),R(!1)}finally{v(!1)}};return f.length===0?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 py-8 px-4",children:e.jsxs("div",{className:"max-w-2xl mx-auto text-center py-16",children:[e.jsx("p",{className:"text-6xl mb-4",children:"ðŸ›’"}),e.jsx("h1",{className:"text-3xl font-bold text-white mb-2",children:"Your Cart is Empty"}),e.jsx("p",{className:"text-slate-400 mb-8",children:"Add products to proceed with checkout"}),e.jsx("button",{onClick:()=>S("/buying"),className:"bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-lg transition",children:"Continue Shopping"})]})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 py-8 px-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx("h1",{className:"text-4xl font-bold text-white mb-2",children:"ðŸ›ï¸ Checkout"}),e.jsx("p",{className:"text-slate-400 mb-8",children:"Complete your order securely"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-slate-800 rounded-lg shadow-lg p-6 border border-slate-700",children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"Order Summary"}),e.jsx("div",{className:"space-y-4",children:f.map(t=>{const a=t.discountedPrice&&t.discountedPrice>0?t.discountedPrice:t.price,s=t.discountPercentage&&t.discountPercentage>0;return e.jsxs("div",{className:"flex justify-between items-start pb-4 border-b border-slate-700",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-white",children:t.productName}),e.jsx("div",{className:"flex items-center gap-2 mt-1",children:s?e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-sm text-slate-400",children:["Qty: ",t.quantity," Ã— â‚¹",a.toFixed(2)]}),e.jsxs("span",{className:"line-through text-slate-500 text-xs",children:["â‚¹",t.price.toFixed(2)]}),e.jsxs("span",{className:"bg-green-600 text-white text-xs font-bold px-1.5 py-0.5 rounded",children:[t.discountPercentage,"% OFF"]})]}):e.jsxs("p",{className:"text-sm text-slate-400",children:["Qty: ",t.quantity," Ã— â‚¹",t.price.toFixed(2)]})}),s&&e.jsxs("p",{className:"text-xs text-green-400 font-semibold mt-1",children:["Saving â‚¹",((t.price-a)*t.quantity).toFixed(2)]})]}),e.jsxs("p",{className:"font-bold text-white",children:["â‚¹",(a*t.quantity).toFixed(2)]})]},t.id)})})]}),e.jsxs("div",{className:"bg-slate-800 rounded-lg shadow-lg p-6 border border-slate-700",children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"ðŸ’³ Payment Method"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-center p-4 border-2 rounded-lg cursor-pointer transition",style:{borderColor:u==="CASH_ON_DELIVERY"?"#f97316":"#475569",backgroundColor:u==="CASH_ON_DELIVERY"?"rgba(249, 115, 22, 0.1)":"transparent"},children:[e.jsx("input",{type:"radio",name:"payment",value:"CASH_ON_DELIVERY",checked:u==="CASH_ON_DELIVERY",onChange:t=>B(t.target.value),className:"w-4 h-4 cursor-pointer"}),e.jsxs("div",{className:"ml-4",children:[e.jsx("p",{className:"font-semibold text-white",children:"ðŸ’µ Cash on Delivery"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Pay when your order arrives"}),e.jsx("p",{className:"text-xs text-green-400 mt-1",children:"âœ“ Free | Delivery in 3-5 days"})]})]}),e.jsxs("label",{className:"flex items-center p-4 border-2 rounded-lg cursor-pointer transition",style:{borderColor:u==="RAZORPAY"?"#22c55e":"#475569",backgroundColor:u==="RAZORPAY"?"rgba(34, 197, 94, 0.1)":"transparent"},children:[e.jsx("input",{type:"radio",name:"payment",value:"RAZORPAY",checked:u==="RAZORPAY",onChange:t=>B(t.target.value),className:"w-4 h-4 cursor-pointer"}),e.jsxs("div",{className:"ml-4 flex-1",children:[e.jsx("p",{className:"font-semibold text-white",children:"ðŸª™ Razorpay (UPI/Card/Netbanking)"}),e.jsx("p",{className:"text-sm text-slate-400",children:"Pay securely online with Razorpay"})]})]})]})]}),e.jsxs("div",{className:"bg-slate-800 rounded-lg shadow-lg p-6 border border-slate-700",children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"ðŸ“ Delivery Address"}),_.length>0&&e.jsx("div",{className:"mb-4",children:e.jsx("select",{value:g||"",onChange:t=>V(t.target.value),className:"w-full px-4 py-2 bg-slate-700 border border-slate-600 text-white rounded-lg focus:ring-2 focus:ring-orange-500",children:_.map(t=>e.jsxs("option",{value:t.id,children:[t.fullName," - ",t.addressLine1,", ",t.city]},t.id))})}),e.jsx("button",{onClick:()=>G(!Y),className:"w-full px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-500 transition font-semibold",children:Y?"âŒ Cancel":"âž• Add New Address"}),Y&&e.jsxs("form",{onSubmit:ce,className:"mt-4 space-y-3",children:[e.jsx("input",{type:"text",name:"fullName",placeholder:"Full Name (as per ID proof)",value:d.fullName,onChange:x,className:"w-full px-4 py-2 bg-slate-700 border border-slate-600 text-white placeholder-slate-400 rounded-lg",required:!0}),e.jsx("input",{type:"email",name:"email",placeholder:"Email Address",value:d.email,onChange:x,className:"w-full px-4 py-2 bg-slate-700 border border-slate-600 text-white placeholder-slate-400 rounded-lg",required:!0}),e.jsx("input",{type:"tel",name:"phoneNumber",placeholder:"10-digit Mobile Number",pattern:"[0-9]{10}",value:d.phoneNumber,onChange:x,className:"w-full px-4 py-2 bg-slate-700 border border-slate-600 text-white placeholder-slate-400 rounded-lg",required:!0}),e.jsx("input",{type:"text",name:"addressLine1",placeholder:"Flat, House no., Building, Company, Apartment",value:d.addressLine1,onChange:x,className:"w-full px-4 py-2 bg-slate-700 border border-slate-600 text-white placeholder-slate-400 rounded-lg",required:!0}),e.jsx("input",{type:"text",name:"addressLine2",placeholder:"Area, Street, Sector, Village (optional)",value:d.addressLine2,onChange:x,className:"w-full px-4 py-2 bg-slate-700 border border-slate-600 text-white placeholder-slate-400 rounded-lg"}),e.jsx("input",{type:"text",name:"landmark",placeholder:"Landmark (e.g. near temple, school)",value:d.landmark,onChange:x,className:"w-full px-4 py-2 bg-slate-700 border border-slate-600 text-white placeholder-slate-400 rounded-lg"}),e.jsxs("select",{name:"addressType",value:d.addressType,onChange:x,className:"w-full px-4 py-2 bg-slate-700 border border-slate-600 text-white rounded-lg",required:!0,children:[e.jsx("option",{value:"",children:"Select Address Type"}),e.jsx("option",{value:"Home",children:"Home"}),e.jsx("option",{value:"Work",children:"Work"}),e.jsx("option",{value:"Other",children:"Other"})]}),e.jsx("input",{type:"text",name:"city",placeholder:"City / Town",value:d.city,onChange:x,className:"w-full px-4 py-2 border border-gray-300 rounded-lg",required:!0}),e.jsx("input",{type:"text",name:"state",placeholder:"State / Province",value:d.state,onChange:x,className:"w-full px-4 py-2 border border-gray-300 rounded-lg",required:!0}),e.jsx("input",{type:"text",name:"postalCode",placeholder:"6-digit PIN Code",pattern:"[0-9]{6}",value:d.postalCode,onChange:x,className:"w-full px-4 py-2 border border-gray-300 rounded-lg",required:!0}),e.jsx("button",{type:"submit",className:"w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold",children:"Save Address"})]})]})]}),e.jsxs("div",{className:"bg-slate-800 rounded-lg shadow-lg p-6 h-fit sticky top-20 border border-slate-700",children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-6",children:"Price Breakdown"}),e.jsxs("div",{className:"space-y-3 border-b border-slate-600 pb-4 mb-4",children:[e.jsxs("div",{className:"flex justify-between text-slate-300",children:[e.jsx("span",{children:"Subtotal:"}),e.jsxs("span",{className:"font-semibold text-white",children:["â‚¹",E.toFixed(2)]})]}),e.jsxs("div",{className:"flex items-center gap-2 my-2",children:[e.jsx("input",{type:"checkbox",checked:w,onChange:ae,id:"use-coins-toggle",className:"w-4 h-4"}),e.jsxs("label",{htmlFor:"use-coins-toggle",className:"text-sm text-slate-300 font-semibold cursor-pointer",children:["Use Coins (",I," available)"]}),w&&e.jsx("input",{type:"number",min:"1",max:Q,value:F,onChange:re,className:"ml-2 px-2 py-1 bg-slate-700 border border-slate-600 text-white rounded w-20 text-right"})]}),i>0&&e.jsxs("div",{className:"flex justify-between text-green-400 font-semibold",children:[e.jsxs("span",{children:["ðŸª™ Coin Discount (",i," coins):"]}),e.jsxs("span",{children:["- â‚¹",(i*z).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-slate-300",children:[e.jsx("span",{children:"Tax & Charges (18% GST):"}),e.jsxs("span",{className:"font-semibold text-white",children:["â‚¹",O.toFixed(2)]})]})]}),e.jsxs("div",{className:"flex justify-between text-xl font-bold mb-6 text-green-400",children:[e.jsx("span",{children:"Final Amount:"}),e.jsxs("span",{children:["â‚¹",p.toFixed(2)]})]}),i>0&&e.jsxs("div",{className:"bg-green-900/30 border-l-4 border-green-500 p-3 mb-4 rounded",children:[e.jsxs("p",{className:"text-sm text-green-300 font-semibold",children:["ðŸ’° You're saving â‚¹",(i*z).toFixed(2)]}),e.jsxs("p",{className:"text-xs text-green-400 mt-1",children:["Using ",i," coins for discount"]})]}),u==="CASH_ON_DELIVERY"&&e.jsxs("div",{className:"bg-blue-900/30 border-l-4 border-blue-500 p-3 mb-4 rounded",children:[e.jsx("p",{className:"text-sm text-blue-300 font-semibold",children:"âœ“ Cash on Delivery"}),e.jsx("p",{className:"text-xs text-blue-400 mt-1",children:"Expected delivery: 3-5 business days"})]}),e.jsx("button",{onClick:W,disabled:H||u==="CASH_ON_DELIVERY"&&!g,className:"w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-4 px-6 rounded-lg transition text-lg",children:H?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx("span",{className:"animate-spin",children:"â³"})," Processing..."]}):"âœ“ Place Order"}),e.jsx("button",{onClick:()=>S("/cart"),className:"w-full mt-3 bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 px-6 rounded-lg transition",children:"Back to Cart"})]})]})]})})}export{ye as default};
//# sourceMappingURL=Checkout-Dv_dWjxr.js.map
